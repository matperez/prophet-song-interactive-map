# Правила извлечения данных для графа знаний из литературного произведения

Этот документ описывает правила для AI-агента, который должен извлечь из текста книги структурированные данные для создания интерактивного графа знаний.

## Структура выходных данных

Данные должны быть представлены в формате TypeScript с двумя основными массивами:
- `nodes` — узлы графа (персонажи, события, группы)
- `links` — связи между узлами

## 1. Идентификация глав

### Правила:
- Ищи заголовки глав в форматах: "Глава N", "Chapter N", "Часть N", "Part N"
- Нумерация может быть арабской (1, 2, 3) или римской (I, II, III)
- Если глав нет явно, разделяй текст на логические части по сюжетным аркам
- Сохраняй соответствие между номером главы и содержанием

### Пример:
```
Глава 1 → chapter: 1
Глава 2 → chapter: 2
```

## 2. Идентификация персонажей (Characters)

### Критерии идентификации:
1. **Имена собственные** — имена людей, упоминаемые многократно
2. **Роли и титулы** — "профсоюзный лидер", "микробиолог", "адвокат"
3. **Семейные связи** — "муж", "жена", "сын", "дочь", "отец", "сестра"
4. **Упоминания в диалогах** — когда персонажи обращаются друг к другу по имени

### Обязательные поля для персонажа:
```typescript
{
  id: string,           // уникальный идентификатор (латиница, lowercase, snake_case)
  label: string,        // полное имя как в книге
  type: 'character',
  group?: string,       // категория: 'family', 'friend', 'authority', 'support', 'enemy'
  chapter?: number[],   // номера глав, где персонаж появляется
  description?: string, // краткое описание роли (1-2 предложения)
  status?: string,      // 'active', 'missing', 'dead', 'escaped' (если применимо)
  details?: string      // дополнительный контекст или символическое значение
}
```

### Правила для `group`:
- **family** — члены семьи главных героев
- **friend** — друзья и близкие знакомые
- **authority** — представители власти, полиции, правительства
- **support** — помощники, союзники, адвокаты
- **enemy** — противники, антагонисты

### Правила для `status`:
- **active** — персонаж активен в повествовании (по умолчанию)
- **missing** — пропал без вести, исчез
- **dead** — погиб
- **escaped** — сбежал, уехал

### Примеры извлечения:
```
"Айлиш Стэк" → {
  id: 'ailish',
  label: 'Айлиш Стэк',
  type: 'character',
  group: 'family',
  chapter: [1,2,3,4,5,6,7,8,9],
  description: 'Мать, жена и микробиолог, пытающаяся сохранить семью...',
  status: 'escaped'
}

"Инспектор Стэмп" → {
  id: 'stamp',
  label: 'Инспектор Стэмп',
  type: 'character',
  group: 'authority',
  chapter: [1,5],
  description: 'Сотрудник ГСНБ, преследующий семью Стэков.'
}
```

## 3. Идентификация событий (Events)

### Критерии идентификации:
1. **Конкретные действия** — "арест", "визит", "встреча", "увольнение"
2. **Значимые происшествия** — события, влияющие на сюжет
3. **Временные маркеры** — "в тот вечер", "на следующий день", "во вторник"
4. **Описательные фразы** — "разгон демонстрации", "ночной обыск"

### Обязательные поля для события:
```typescript
{
  id: string,           // уникальный идентификатор (формат: 'e{chapter}_{short_name}')
  label: string,        // краткое название события (2-5 слов)
  type: 'event',
  chapter: number,      // номер главы, где происходит событие
  description: string   // описание события (1-2 предложения)
}
```

### Правила именования ID событий:
- Формат: `e{номер_главы}_{краткое_название}`
- Используй латиницу, lowercase, snake_case
- Примеры: `e1_visit`, `e2_new_law`, `e5_raid`

### Примеры извлечения:
```
"Стэмп и его напарник приходят к Айлиш в поисках Ларри" → {
  id: 'e1_visit',
  label: 'Визит инспекторов',
  type: 'event',
  chapter: 1,
  description: 'Стэмп и его напарник приходят к Айлиш в поисках Ларри.'
}

"Ларри арестован во время забастовки учителей" → {
  id: 'e1_arrest',
  label: 'Арест на митинге',
  type: 'event',
  chapter: 1,
  description: 'Ларри арестован во время забастовки учителей.'
}
```

## 4. Идентификация групп (Groups)

### Критерии:
- Организации, институты, коллективные субъекты
- Упоминаются как единое целое, а не как отдельные люди
- Примеры: "ГСНБ", "профсоюз", "правительство", "армия"

### Обязательные поля:
```typescript
{
  id: string,
  label: string,
  type: 'group',
  group?: string,       // категория группы
  description: string,
  details?: string
}
```

## 5. Идентификация связей (Links)

### Типы связей между персонажами:

#### Семейные связи:
- "Супруги", "Мать и сын", "Отец и дочь", "Братья", "Сестры"
- Ищи фразы: "муж", "жена", "сын", "дочь", "отец", "мать", "брат", "сестра"

#### Социальные связи:
- "Друзья", "Коллеги", "Работодатель", "Подчиненный"
- Ищи упоминания профессий, рабочих мест, совместной деятельности

#### Конфликтные связи:
- "Преследователь", "Жертва", "Противник"
- Ищи описания конфликтов, противостояний

### Типы связей персонаж-событие:

#### Роли в событиях:
- **Участник** — присутствует при событии
- **Инициатор** — начинает событие
- **Жертва** — страдает от события
- **Исполнитель** — выполняет действие
- **Свидетель** — наблюдает событие
- **Адресат** — получает что-то в событии
- **Консультант** — дает совет
- **Проводник** — помогает в перемещении

### Обязательные поля для связи:
```typescript
{
  source: string,      // ID узла-источника
  target: string,      // ID узла-цели
  label: string,       // тип связи (1-3 слова)
  description?: string // дополнительный контекст связи
}
```

### Правила извлечения связей:

1. **Семейные связи:**
   ```
   "Айлиш" + "Ларри" + контекст "муж", "жена" → 
   { source: 'ailish', target: 'larry', label: 'Супруги' }
   ```

2. **Связи персонаж-событие:**
   ```
   В главе 1: "Айлиш открывает дверь инспекторам" →
   { source: 'ailish', target: 'e1_visit', label: 'Участник' }
   
   "Стэмп приходит к Айлиш" →
   { source: 'stamp', target: 'e1_visit', label: 'Инициатор' }
   ```

3. **Конфликтные связи:**
   ```
   "ГСНБ арестовала Ларри" →
   { source: 'gsnb', target: 'larry', label: 'Арест' }
   ```

## 6. Алгоритм работы агента

### Этап 1: Предобработка текста
1. Раздели текст на главы
2. Нормализуй имена (приведи к единому формату)
3. Выдели диалоги и описания

### Этап 2: Извлечение персонажей
1. Найди все имена собственные (люди)
2. Для каждого имени:
   - Определи частоту упоминаний
   - Найди описание роли/профессии
   - Определи группу (family/friend/authority/support)
   - Отследи появление в главах
   - Определи финальный статус (если есть)

### Этап 3: Извлечение событий
1. Найди глаголы действия: "арестовали", "пришли", "уволили", "умер"
2. Для каждого значимого действия:
   - Определи, в какой главе происходит
   - Создай краткое название
   - Составь описание из контекста
   - Свяжи с персонажами-участниками

### Этап 4: Извлечение связей
1. Для каждой пары персонажей:
   - Найди упоминания их вместе
   - Определи тип связи из контекста
   - Добавь описание, если есть важный контекст

2. Для каждого события:
   - Найди всех упомянутых персонажей
   - Определи роль каждого в событии
   - Создай связи с соответствующими метками

### Этап 5: Валидация и очистка
1. Убедись, что все ID уникальны
2. Проверь, что все связи ссылаются на существующие узлы
3. Убедись, что номера глав соответствуют реальным главам
4. Проверь согласованность данных (например, если персонаж "dead", не должно быть событий с ним после смерти)

## 7. Особые случаи и исключения

### Имена с вариациями:
- "Айлиш" и "Айлиш Стэк" → один персонаж
- "Инспектор Стэмп" и "Стэмп" → один персонаж
- Используй наиболее полное имя как `label`, короткое — для поиска

### Временные персонажи:
- Если персонаж упоминается 1-2 раза без влияния на сюжет — можно пропустить
- Если персонаж важен для понимания сюжета — включи его

### События-процессы:
- Если событие растянуто во времени (например, "осада"), создай одно событие с описанием процесса
- Если событие имеет четкие этапы в разных главах — создай отдельные события

### Группы vs персонажи:
- Если организация действует через конкретных людей → создай и группу, и персонажей
- Если организация действует абстрактно → только группа

## 8. Формат выходного файла

Файл должен быть TypeScript модулем:

```typescript
import { BookData } from './types';

export const BOOK_DATA: BookData = {
  nodes: [
    // Персонажи
    // События
    // Группы
  ],
  links: [
    // Связи между узлами
  ]
};
```

## 9. Качество данных

### Критерии хорошего извлечения:
- ✅ Все главные персонажи идентифицированы
- ✅ Все ключевые события извлечены
- ✅ Связи отражают реальные отношения из книги
- ✅ Номера глав точны
- ✅ Описания информативны и не содержат спойлеров
- ✅ ID уникальны и читаемы

### Что НЕ нужно извлекать:
- ❌ Мелкие бытовые детали без влияния на сюжет
- ❌ Внутренние монологи без внешних действий
- ❌ Описания природы/погоды без связи с событиями
- ❌ Повторяющиеся рутинные действия

## 10. Пример полного извлечения

```typescript
{
  id: 'ailish',
  label: 'Айлиш Стэк',
  type: 'character',
  group: 'family',
  chapter: [1,2,3,4,5,6,7,8,9],
  description: 'Мать, жена и микробиолог, пытающаяся сохранить семью в распадающемся обществе.',
  status: 'escaped',
  details: 'Ее путь — это путь от отрицания к полному осознанию трагедии.'
}
```

Связь:
```typescript
{
  source: 'ailish',
  target: 'e1_visit',
  label: 'Участник',
  description: 'Айлиш открывает дверь инспекторам ГСНБ.'
}
```

---

**Примечание:** Эти правила должны применяться гибко, с учетом особенностей конкретного произведения. Агент должен понимать контекст и не извлекать данные механически, а анализировать смысл и важность элементов для сюжета.

